<?php
require_once "./components/user.php";
$referals = db_getConnection()->query("SELECT * FROM `users` WHERE `ref_id` = '{$_COOKIE['id']}'")->fetchAll();
$refsallaryArray = db_getConnection()->query("SELECT * FROM `transactions` WHERE `subtype` = 'referral' and `user_id`={$_COOKIE['id']}")->fetchAll();
$refsallary = 0;
foreach ($refsallaryArray as $item) {
    $refsallary += $item['amount'];
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bliss Trade</title>
    <link rel="stylesheet" href="../css/swiper-bundle.min.css">
    <link rel="stylesheet" href="../css/fonts.css">
    <link rel="stylesheet" href="../css/fortunepopup.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="../css/mobile.css">
</head>
<body>
<div id="admin">
    <?php include "./components/header.php" ?>
    <?php include "./components/navbar.php" ?>
    <main id="referals">
        <div class="infotexts">
            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M52.2667 13.2001C53.8667 15.5667 54.8 18.4001 54.8 21.4667C54.7667 29.4667 48.4667 35.9667 40.5333 36.2334C40.2 36.2001 39.8 36.2001 39.4333 36.2334C32.0667 36.0001 26.1 30.3667 25.3 23.1667C24.3333 14.6001 31.3667 6.66675 39.9667 6.66675"
                      stroke="black" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M23.3 48.5333C15.2333 53.9333 15.2333 62.7333 23.3 68.0999C32.4667 74.2333 47.5 74.2333 56.6667 68.0999C64.7333 62.6999 64.7333 53.8999 56.6667 48.5333C47.5667 42.4333 32.5333 42.4333 23.3 48.5333Z"
                      stroke="black" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1>Рефералы</h1>
        </div>
        <div class="threeblocks">
            <div class="threeblock">
                <svg width="144" height="115" viewBox="0 0 144 115" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M100.497 0H133.393C138.821 0 143.262 4.44095 143.262 9.86879V42.7647C143.262 48.1926 138.821 52.6335 133.393 52.6335H126.156V99.6747H134.873C135.783 99.6747 136.518 100.41 136.518 101.32V107.076C136.518 111.432 132.975 114.973 128.623 114.973H7.89503C3.54125 114.973 0 111.43 0 107.076V101.32C0 100.41 0.736869 99.6747 1.6448 99.6747H10.3622V35.1987C10.3622 29.4846 15.0104 24.8364 20.7244 24.8364H90.6283V9.86879C90.6283 4.44095 95.0693 0 100.497 0ZM117.274 14.8032C114.478 14.8032 112.175 16.7769 111.846 19.4086V20.231C111.846 23.1916 114.313 25.6588 117.274 25.6588C120.07 25.6588 122.373 23.5206 122.702 20.8889V20.231C122.702 18.5862 122.044 17.1059 120.893 16.119C120.07 15.4611 119.083 14.9677 117.932 14.8032H117.274ZM128.623 111.683C131.163 111.683 133.229 109.616 133.229 107.076V102.964H81.5523C80.8253 105.91 78.0917 107.734 74.1787 107.734H62.1717C58.2604 107.734 55.5267 105.91 54.7997 102.964H3.28959V107.076C3.28959 109.616 5.35546 111.683 7.89503 111.683H128.623ZM80.1016 99.6747H122.866V52.6335H100.497C95.0693 52.6335 90.6283 48.1926 90.6283 42.7647V28.126H20.7244C16.8904 28.126 13.6518 31.3646 13.6518 35.1987V99.6747H56.2504C57.1584 99.6747 57.8952 100.41 57.8952 101.32C57.8952 104.038 60.5746 104.445 62.1717 104.445H74.1787C75.7775 104.445 78.4568 104.038 78.4568 101.32C78.4568 100.41 79.1921 99.6747 80.1016 99.6747ZM106.418 31.5801L105.267 39.3107H128.294L127.143 31.5801C126.814 29.4419 125.005 27.7971 122.866 27.9616H116.781H110.695C108.557 27.9616 106.747 29.4419 106.418 31.5801ZM49.3438 83.2268C50.4951 71.2197 60.1994 62.0089 72.3709 61.6799V54.2783L87.1741 67.1077L72.3709 79.9372V73.029C63.3245 71.0553 53.9492 75.3317 49.3438 83.2268Z"
                          fill="black"/>
                </svg>
                <p>Переходы по ссылке </p>
                <h1><?= $user['ref_link_counter'] ?></h1>
            </div>
            <div class="threeblock">
                <svg width="136" height="116" viewBox="0 0 136 116" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M136 41.8462C136 47.1574 131.654 51.503 126.343 51.503H123.768V100.109H132.137C133.027 100.109 133.747 100.828 133.747 101.718V107.351C133.747 111.612 130.28 115.077 126.021 115.077H7.72544C3.46518 115.077 0 111.61 0 107.351V101.718C0 100.828 0.721041 100.109 1.60947 100.109H10.4615V37.0177C10.4615 31.4265 15.0099 26.8781 20.6012 26.8781H84.497V9.6568C84.497 4.34556 88.8426 0 94.1538 0H126.343C131.654 0 136 4.34556 136 9.6568V41.8462ZM124.895 25.4296C124.895 17.6076 118.553 11.2663 110.731 11.2663C102.909 11.2663 96.5681 17.6076 96.5681 25.4296C96.5681 33.2516 102.909 39.5929 110.731 39.5929C118.553 39.5929 124.895 33.2516 124.895 25.4296ZM126.021 111.858C128.506 111.858 130.528 109.836 130.528 107.351V103.329H80.1241C79.4127 106.212 76.7378 107.995 72.9089 107.995H61.1598C57.3325 107.995 54.6559 106.21 53.9445 103.328H3.21894V107.351C3.21894 109.836 5.24043 111.858 7.72544 111.858H126.021ZM78.703 100.109H120.549V51.503H94.1538C88.8426 51.503 84.497 47.1574 84.497 41.8462V30.097H20.6012C16.8495 30.097 13.6805 33.2661 13.6805 37.0177V100.109H55.3657C56.2541 100.109 56.9752 100.828 56.9752 101.718C56.9752 104.377 59.597 104.775 61.1598 104.775H72.9073C74.4717 104.775 77.0935 104.377 77.0935 101.718C77.0935 100.828 77.8129 100.109 78.703 100.109ZM110.731 36.374C116.775 36.374 121.676 31.4747 121.676 25.4296C121.676 19.3844 116.775 14.4852 110.731 14.4852C104.688 14.4852 99.787 19.3844 99.787 25.4296C99.787 31.4747 104.686 36.374 110.731 36.374ZM110.731 20.9231C113.22 20.9231 115.238 22.9413 115.238 25.4296C115.238 27.9178 113.22 29.9361 110.731 29.9361C108.243 29.9361 106.225 27.9178 106.225 25.4296C106.225 22.9413 108.243 20.9231 110.731 20.9231ZM88.5214 60.5161H89.1652C90.2919 60.838 91.4185 61.3208 92.3842 62.1256C93.6717 63.2522 94.4765 64.8617 94.4765 66.6321V67.4368C94.1546 70.3339 91.5794 72.5871 88.5214 72.5871C85.1416 72.5871 82.5664 69.851 82.5664 66.6321V65.6664C83.0492 62.7694 85.4634 60.5161 88.5214 60.5161ZM51.8261 67.4368C51.5042 70.3339 48.9291 72.5871 45.8711 72.5871C42.4912 72.5871 39.916 69.8511 39.916 66.6321V65.6664C40.3989 62.7694 42.8131 60.5161 45.8711 60.5161H46.5149C47.6415 60.838 48.7681 61.3209 49.7338 62.1256C51.0214 63.2522 51.8261 64.8617 51.8261 66.6321V67.4368ZM45.7089 75.1624H52.4686C54.8828 75.1624 56.9751 76.9329 57.297 79.1861L58.5846 87.7163H32.9941L34.2817 79.1861C34.6035 76.7719 36.5349 75.1624 38.9491 75.1624H45.7089ZM81.5996 75.1626C79.1854 75.1626 77.254 76.7721 76.9321 79.1863L75.6445 87.7164H101.235L99.9475 79.1863C99.6256 76.933 97.5333 75.1626 95.1191 75.1626H88.3593H81.5996Z"
                          fill="black"/>
                </svg>

                <p>Зарегистрированы </p>
                <h1><?= count($referals) ?></h1>
            </div>
            <div class="threeblock">
                <svg width="136" height="115" viewBox="0 0 136 115" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M44.8202 11.5273H127.457C132.166 11.5273 136 15.1184 136 19.5323V82.7723C136 87.1863 132.168 90.7774 127.457 90.7774H103.049L125.762 112.06C126.43 112.686 126.43 113.697 125.762 114.323C125.429 114.636 124.992 114.793 124.554 114.793C124.117 114.793 123.68 114.636 123.347 114.323L98.219 90.7774H79.9598V113.192C79.9598 114.077 79.1961 114.793 78.2513 114.793C77.3064 114.793 76.5427 114.077 76.5427 113.192V90.7774H58.451L33.1543 114.327C32.8211 114.637 32.3854 114.793 31.9497 114.793C31.5124 114.793 31.0716 114.634 30.7384 114.32C30.0738 113.691 30.0772 112.679 30.7469 112.056L53.6055 90.7774H26.1407C21.4303 90.7774 17.598 87.1863 17.598 82.7723V44.0118C7.4595 41.4102 0 32.7391 0 22.4142C0 10.0351 10.7091 0 23.9196 0C32.9117 0 40.7351 4.65414 44.8202 11.5273ZM15.3769 30.5793C15.3769 31.4631 16.1423 32.1803 17.0854 32.1803H23.0653V35.8627C23.0653 36.7464 23.8308 37.4637 24.7739 37.4637C25.717 37.4637 26.4824 36.7464 26.4824 35.8627V32.1803H27.6784C31.227 32.1803 33.8291 29.5018 33.8291 26.4167C33.8291 23.2915 31.0135 20.6531 27.6784 20.6531H21.5276C19.9507 20.6531 18.794 19.4891 18.794 18.0914C18.794 16.7338 20.0788 15.5298 21.5276 15.5298H30.4121C31.3552 15.5298 32.1206 14.8126 32.1206 13.9288C32.1206 13.045 31.3552 12.3278 30.4121 12.3278H26.4824V9.60607C26.4824 8.72231 25.717 8.00506 24.7739 8.00506C23.8308 8.00506 23.0653 8.72231 23.0653 9.60607V12.3278H21.5276C18.1926 12.3278 15.3769 14.9663 15.3769 18.0914C15.3769 21.1766 17.979 23.8551 21.5276 23.8551H27.6784C29.1272 23.8551 30.4121 25.059 30.4121 26.4167C30.4121 27.8144 29.2554 28.9783 27.6784 28.9783H24.7875H24.7739H24.7602H17.0854C16.1423 28.9783 15.3769 29.6956 15.3769 30.5793ZM21.0151 76.2082H132.583V19.5323C132.583 16.8843 130.283 14.7293 127.457 14.7293H46.3664C47.3027 17.1292 47.8392 19.7101 47.8392 22.4142C47.8392 34.7932 37.1301 44.8283 23.9196 44.8283C22.9338 44.8283 21.9684 44.7547 21.0151 44.6474V76.2082ZM112.46 28.6802C112.462 28.6818 112.464 28.6834 112.464 28.685C112.544 28.8643 112.575 29.0532 112.581 29.2405C112.581 29.2509 112.584 29.2601 112.587 29.2693C112.59 29.2785 112.593 29.2877 112.593 29.2981V40.8254C112.593 41.7092 111.83 42.4264 110.885 42.4264C109.94 42.4264 109.176 41.7092 109.176 40.8254V33.163L81.8516 58.768C81.1835 59.394 80.1037 59.394 79.4357 58.768L62.5365 42.9324L39.8248 64.3667C39.4917 64.6821 39.0526 64.8406 38.6135 64.8406C38.1778 64.8406 37.7421 64.6853 37.409 64.3763C36.7392 63.7519 36.7358 62.7401 37.4004 62.1125L61.32 39.5366C61.6395 39.2356 62.0752 39.0643 62.5297 39.0643H62.5331C62.9858 39.0643 63.4215 39.2324 63.741 39.5334L80.6436 55.3722L106.76 30.8992H96.3622C95.4174 30.8992 94.6537 30.1819 94.6537 29.2981C94.6537 28.4144 95.4174 27.6971 96.3622 27.6971H110.885C111.093 27.6971 111.291 27.742 111.481 27.8092C111.524 27.8239 111.564 27.8432 111.605 27.8629C111.618 27.869 111.63 27.8752 111.643 27.8812C111.773 27.9421 111.889 28.0157 111.999 28.1054C112.011 28.1157 112.024 28.1257 112.036 28.1355C112.068 28.1609 112.099 28.1859 112.129 28.2159C112.253 28.3407 112.358 28.48 112.434 28.6401C112.438 28.6473 112.443 28.6537 112.447 28.6602C112.452 28.6666 112.457 28.673 112.46 28.6802Z"
                          fill="black"/>
                </svg>

                <p>Реферальный доход </p>
                <h1>$<?= $refsallary ?></h1>
            </div>
        </div>
        <p class="dsrc_texts">Привлекайте больше партнеров за каждого привлеченного партнера
            получаете <?= $user['ref_percent'] ?>% от суммы его
            пополнения!</p>
        <div class="reflinkblock">
            <h3>Ваш личный реферальный URL-адрес</h3>
            <div class="input">
                <span><?= $domain . "?ref=" . $_COOKIE['id'] ?></span>
                <button class="helpbutton"
                        onclick="copyToClipboard('<?= $domain . "?ref=" . $_COOKIE['id'] ?>')">Copy
                </button>
            </div>
            <p>Действует ограничение для регистраций (<?= $user['ref_limit'] ?>)</p>
        </div>
        <?php if (count($referals) !== 0): ?>
            <div id="tabs">
                <div class="tabcontent">
                    <div class="tabContent">
                        <div class="column">
                            <p class="columnheader">
                                Имя
                            </p>
                            <?php foreach ($referals as $referal): ?>
                                <span><?= $referal['name'] ?></span>
                            <?php endforeach; ?>
                        </div>
                        <div class="column">
                            <p class="columnheader">
                                Логин
                            </p>
                            <?php foreach ($referals as $referal): ?>
                                <span><?php
                                    $email = "supert@gmail.com";
                                    $parts = explode("@", $referal['email']);
                                    $username = $parts[0];
                                    $domain = $parts[1];

                                    // Оставляем только первые 3 символа в имени пользователя
                                    $username = substr($username, 0, 3);

                                    // Скрываем символы в имени пользователя
                                    $username_hidden = $username . "**";

                                    // Заменяем все символы после "@" и до ".com" на "***"
                                    $domain_hidden = "***";
                                    $parts = explode(".", $domain);
                                    $domain_hidden .= "." . end($parts);

                                    // Формируем скрытый email-адрес
                                    $hidden_email = $username_hidden . "@" . $domain_hidden;

                                    echo $hidden_email; // выведет "sup**@gm***l.com"

                                    ?></span>
                            <?php endforeach; ?>
                        </div>
                        <div class="column">
                            <p class="columnheader">
                                Дата и Время
                            </p>
                            <?php foreach ($referals as $referal): ?>
                                <span><?= $referal['date_register'] ?></span>
                            <?php endforeach; ?>
                        </div>
                        <!--                        <div class="column">-->
                        <!--                            <p class="columnheader">-->
                        <!--                                Время-->
                        <!--                            </p>-->
                        <!--                            <span> 01:05 </span>-->
                        <!--                            <span> 01:05 </span>-->
                        <!--                        </div>-->
                    </div>
                </div>
            </div>
        <?php endif; ?>
    </main>
</div>

<script src="../js/jquery.js"></script>
<script type="module" src="../js/admin.js"></script>
<script src="../js/infopopup.js"></script>
<script src="../js/adminfunctions.js"></script>

<script src="../js/burger.js"></script>
</body>
</html>
